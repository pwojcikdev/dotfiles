# syntax = docker/dockerfile:experimental
ARG ENV_REPOSITORY=nanocurrency/nano-env
ARG COMPILER=gcc
FROM ${ENV_REPOSITORY}:${COMPILER} as builder

ARG NETWORK=dev
ARG CI_TAG=DEV_BUILD
ARG CI_BUILD=ON
ARG BUILD_TYPE=Debug
ARG BUILD_TARGET=build_tests
ARG SANITIZERS

COPY ./ /tmp/src

WORKDIR /tmp/build

RUN --mount=type=cache,target=/tmp/build \
cmake /tmp/src \
-DCI_BUILD=${CI_BUILD} \
-DPORTABLE=1 \
-DACTIVE_NETWORK=nano_${NETWORK}_network \
-DNANO_TEST=ON \
-DNANO_WARN_TO_ERR=ON \
-DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
-DCI_TEST="1" \
-DNANO_STACKTRACE_BACKTRACE=ON \
${SANITIZERS:-}

RUN --mount=type=cache,target=/tmp/build \
make ${BUILD_TARGET} -j $(nproc)

RUN --mount=type=cache,target=/tmp/build \
cp -r /tmp/build /tmp/out

FROM ubuntu:22.04

COPY --from=builder  /tmp/out/core_test /usr/bin
COPY --from=builder  /tmp/out/rpc_test /usr/bin
COPY --from=builder  /tmp/out/slow_test /usr/bin

WORKDIR /root
USER root

ENV PATH="${PATH}:/usr/bin"
ENTRYPOINT [ "core_test" ]